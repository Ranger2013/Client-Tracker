// @ts-nocheck
import ManageClient from"../../../../../classes/ManageClient.js";import ManageUser from"../../../../../classes/ManageUser.js";import{buildGenericSelectOptions}from"../../../../../utils/dom/buildGenericSelectOptions.js";import{clearMsg,myError}from"../../../../../utils/dom/domUtils.js";import{ucwords,underscoreToSpaces}from"../../../../../utils/string/stringUtils.js";import calculateTotalCost from"./calculateTotalCost.js";import buildHorseListSelectElements from"./showHorseListSelectElements.js";import{updateTrimCost}from"./updateTrimCost.js";const ERROR_MSG="We encountered an error. Unable to show the list of horses at this time.";export default async function showListOfHorses({evt:e,horseListContainer:r,primaryKey:t}){try{if(!(r=getHorseListContainer(r)))return;if(0===getNumberHorsesInput(e))return void(r.innerHTML="");const{clientHorses:s,clientTotalHorses:o}=await getClientInfo(t),i=await getUserFarrierPrices(),n=getOptionsConfig(s,i),a=r.children.length,l=await handleShowingNumberOfHorses({evt:e,horseListContainer:r,clientTotalHorses:o,farrierPrices:i,optionsConfig:n,containerChildren:a});l?.forEach((e=>r.appendChild(e)));const c=document.getElementById("number-horses").value;await Promise.all([updateTrimCost({blockElementNode:r,numberHorses:c,userFarrierPrices:i}),calculateTotalCost()])}catch(e){handleError(e,r)}}function getHorseListContainer(e){return"string"!=typeof e||(e=document.getElementById(e))?e:(myError("form-msg","Unable to find the horse list container."),null)}function getNumberHorsesInput(e){return""===e.target.value?null:Number(e.target.value)}async function getClientInfo(e){const r=new ManageClient,t=await r.getClientInfo({primaryKey:e}),s=t?.horses||[];return{clientHorses:s,clientTotalHorses:s.length>0?s.length:1}}async function getUserFarrierPrices(){const e=new ManageUser;return await e.getFarrierPrices()}function getOptionsConfig(e,r){const{accessories:t,...s}=r;return{horseListOptionsConfig:{list:e,value:e=>`${e.hID}:${e.horse_name}`,text:e=>e.horse_name},farrierPricesOptionsConfig:{list:Object.entries(s).filter((([e,r])=>""!==r&&"0.00"!==r&&0!==r)).reduce(((e,[r,t])=>{const s=r.includes("trim");return s&&!e.trim?(e.trim=!0,e.list.push({shoe:"trim",price:"xxx"})):s||e.list.push({shoe:r,price:t}),e}),{trim:!1,list:[]}).list,value:e=>`${e.shoe}:${e.price}`,text:e=>ucwords(underscoreToSpaces(e.shoe))},accessoryOptionsConfig:{list:Object.entries(t).filter((([e,r])=>r.length>0)).flatMap((([e,r])=>r.map((r=>({type:e,acc:r.name||e,price:r.cost}))))),value:e=>`${e.type}:${e.acc}:${e.price}`,text:e=>ucwords(e.acc)}}}async function handleError(e,r){const{handleError:t}=await import("../../../../../utils/error-messages/handleError.js");await t("showListOfHorsesError","Show list of horses error: ",e,ERROR_MSG,r)}async function handleShowingNumberOfHorses({evt:e,horseListContainer:r,clientTotalHorses:t,farrierPrices:s,optionsConfig:o,containerChildren:i}){try{let s=""===e.target.value?null:Number(e.target.value);if(clearMsg({container:"number-horses-error",hide:!0,input:"number-horses"}),!s)return void myError("number-horses-error","Please enter the number of horses.","number-horses");const n=[];if(0===i&&s>0&&s<t){for(let e=0;e<s;e++){const r=e+1,t=await buildHorseListSelectElements({iterator:r,horseListOptions:buildGenericSelectOptions(o.horseListOptionsConfig),farrierPricesOptions:buildGenericSelectOptions(o.farrierPricesOptionsConfig),accessoryOptions:buildGenericSelectOptions(o.accessoryOptionsConfig)});n.push(t)}return n}if(i>0&&s>i&&s<t){for(let e=i;e<s;e++){const t=e+1,s=r.querySelectorAll('select[id^="horse-list-"]'),i={...o.horseListOptionsConfig},a=Array.from(s).map((e=>e.value)).filter((e=>"null"!==e)),l=i.list.filter((({hID:e,horse_name:r})=>{const t=`${e}:${r}`;return!a.includes(t)})),c=await buildHorseListSelectElements({iterator:t,horseListOptions:buildGenericSelectOptions({...i,list:l}),farrierPricesOptions:buildGenericSelectOptions(o.farrierPricesOptionsConfig),accessoryOptions:buildGenericSelectOptions(o.accessoryOptionsConfig)});n.push(c)}return n}if(s>=t){s>t&&(myError("form-msg","You cannot select more horses than the client has."),s=t,e.target.value=t),r.innerHTML="";const{default:i}=await import("./autoFillHorseList.js"),n=await i({totalHorses:t,optionsConfig:o});return n.map((e=>e.querySelector('select[id^="horse-list-"]'))).forEach((e=>{const r=e.options[e.selectedIndex];Array.from(e.options).forEach((t=>{t!==r&&e.removeChild(t)}))})),n}if(s<i){let e=i,t=[];const[o,a]=await Promise.all([import("./removeLastChildAndGetOption.js"),import("./addOptionToRemainingHorseListSelectElements.js")]),{default:l}=o,{default:c}=a;for(;e>s;){const s=await l(r);s&&t.push(s),e--}return t.forEach((e=>c(r,e))),n}}catch(e){const{handleError:r}=await import("../../../../../utils/error-messages/handleError.js");throw await r("handleShowingNumberOfHorsesError","Handle showing number of horses error: ",e),e}}