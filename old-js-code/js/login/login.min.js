// @ts-nocheck
import IndexedDBOperations from"../classes/IndexedDBOperations.js";import{loginAPI}from"../utils/network/apiEndpoints.js";import{fetchData}from"../utils/network/network.js";import{myError,mySuccess}from"../utils/dom/domUtils.js";import errorLogs from"../utils/error-messages/errorLogs.js";import userDataStructureConfig from"../utils/configurations/user-settings-structure/userSettingsDataStructure.js";const fm=document.getElementById("form-msg"),loginForm=document.getElementById("login-form");async function handleLogIn(r){r.preventDefault();try{mySuccess(fm,"Processing...","w3-text-blue");const t=Object.fromEntries(new FormData(r.target));if(""===t.username||""===t.password)return void myError(fm,"User Name and Password are required.");const e=await fetchData({api:loginAPI,data:t});if("ok"===e.status){const r=e.msg;if(!r)return void myError(fm,"You have a token validation issue. Please contact the administrator directly with this issue.");try{console.log("Inner try block: req: ",e);const t=new IndexedDBOperations,o=await t.openDBPromise();let s=await t.getAllStorePromise(o,t.stores.USERSETTINGS);if(Array.isArray(s)&&0!==s.length&&void 0!==s[0]||(s=null),s&&s.length>0)s[0].userToken=r,s[0].user_status.status=e.member_status,s[0].user_status.expiry=e.account_expiry,await t.clearStorePromise(o,t.stores.USERSETTINGS),await t.putStorePromise(o,s[0],t.stores.USERSETTINGS);else{await t.clearStorePromise(o,t.stores.USERSETTINGS);const s=userDataStructureConfig({validationToken:r,req:e});await t.putStorePromise(o,s,t.stores.USERSETTINGS)}window.location.href="/tracker/"}catch(r){return console.warn("Unable to log in: ",r),await errorLogs("loginError","Login error: ",r),void myError(fm,"Unknown Error.<br>Please contact the administrator directly at 409-268-0572 concering this issue.".err)}}else"error"===e.status&&myError(fm,e.msg)}catch(r){await errorLogs("loginError","Login error: ",r),myError(fm,"There was an issue logging you in.<br>Please contact the administrator directly about this issue.")}}loginForm.addEventListener("submit",handleLogIn);