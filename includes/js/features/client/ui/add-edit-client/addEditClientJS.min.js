// @ts-nocheck
import checkAppointment from"../../../../core/services/appointment-block/checkAppointment.min.js";import{disableEnableSubmitButton}from"../../../../core/utils/dom/elements.min.js";import{createDebouncedHandler,getOptimalDelay}from"../../../../core/utils/dom/eventUtils.min.js";import getAllFormIdElements from"../../../../core/utils/dom/forms/getAllFormIDElements.min.js";import{trimCycleRange}from"../../../../core/utils/dom/forms/trimCycleConfigurations.min.js";import{addListener,removeListeners}from"../../../../core/utils/dom/listeners.min.js";import{clearMsg,safeDisplayMessage}from"../../../../core/utils/dom/messages.min.js";import{hyphenToSpaces,hyphenToUnderscore,ucwords}from"../../../../core/utils/string/stringUtils.min.js";import{top}from"../../../../core/utils/window/scroll.min.js";const FORM_FIELDS=["client-name","street","city","state","zip","distance","phone","email","trim-cycle"];export default async function addEditClient({cID:e,primaryKey:t,clientInfo:n,manageClient:r,manageUser:o,componentId:a}){try{const s=getAllFormIdElements("client-form");if(document.querySelector('[data-component="client-navigation"]')){const{default:e}=await import("../../../../core/navigation/components/setupClientAnchorListener.js");await e({manageClient:r,manageUser:o,componentId:a})}initializeAppointmentCheck({elements:s,clientInfo:n,manageClient:r,manageUser:o,componentId:a}),initializeForm({cID:e,primaryKey:t,clientInfo:n,manageClient:r,manageUser:o,componentId:a})}catch(e){const{AppError:t}=await import("../../../../core/errors/models/AppError.js");t.handleError(e,{errorCode:t.Types.INITIALIZATION_ERROR,userMessage:t.BaseMessages.system.initialization});const n=document.getElementById("submit-button");n&&(n.disabled=!0)}}function initializeAppointmentCheck({elements:e,clientInfo:t,manageClient:n,manageUser:r,componentId:o}){const a={trimDate:e["trim-date"],trimCycle:e["trim-cycle"],appBlock:"appointment-block",projAppBlock:"projected-appointment-block",clientInfo:t,manageClient:n,manageUser:r};checkAppointment(a),addListener({elementOrId:"trim-date",eventType:"change",handler:()=>{checkAppointment(a)},componentId:o})}function initializeForm({cID:e,primaryKey:t,clientInfo:n,manageClient:r,manageUser:o,componentId:a}){const s=document.getElementById("client-form");s&&(addListener({elementOrId:s,eventType:"input",handler:async o=>{const s=o.target;if(FORM_FIELDS.includes(s.id)){createDebouncedHandler((()=>handleFormValidation({evt:o,field:s.id,cID:e,primaryKey:t,clientInfo:n,manageClient:r,componentId:a})),getOptimalDelay("validation"))()}},componentId:a}),addListener({elementOrId:s,eventType:"submit",handler:s=>{s.preventDefault(),handleFormSubmission({evt:s,cID:e,primaryKey:t,clientInfo:n,manageClient:r,manageUser:o,componentId:a})},componentId:a}))}async function handleFormValidation({evt:e,field:t,cID:n,primaryKey:r,clientInfo:o,manageClient:a,componentId:s}){try{const o=await checkClientFormValidity({evt:e,cID:n,primaryKey:r,manageClient:a}),i=`${t}-error`;o?(safeDisplayMessage({elementId:i,message:o,targetId:t}),addListener({elementOrId:t,eventType:"focus",handler:()=>clearMsg({container:i,hide:!0,input:t}),componentId:s})):clearMsg({container:i,hide:!0,input:t}),await disableEnableSubmitButton("submit-button")}catch(e){const{AppError:t}=await import("../../../../core/errors/models/AppError.js");t.process(e,{errorCode:t.Types.FORM_VALIDATION_ERROR,userMessage:t.BaseMessages.forms.validationFailed,displayTarget:"form-msg"},!0),document.getElementById("submit-button").disabled=!0}}async function checkClientFormValidity({evt:e,cID:t,primaryKey:n,manageClient:r}){try{if("client-form"===e.target.id)return!0;const o=`validate${ucwords(hyphenToSpaces(e.target.id)).replace(" ","")}`,a=(await import(`./components/${o}.js`)).default;if("function"==typeof a)return a({evt:e,cID:t,primaryKey:n,manageClient:r});throw new Error("Invalid function name.")}catch(e){const{AppError:t}=await import("../../../../core/errors/models/AppError.js");t.process(e,{errorCode:t.Types.FORM_VALIDATION_ERROR,userMessage:t.BaseMessages.forms.validationFailed,displayTarget:"form-msg"},!0)}}async function validateAllFormFields({userData:e,cID:t,primaryKey:n,manageClient:r}){let o=!1;for(const a of FORM_FIELDS){e[hyphenToUnderscore(a)];const s=document.getElementById(a);if(!s)continue;const i={target:s},m=await checkClientFormValidity({evt:i,cID:t,primaryKey:n,manageClient:r});m&&(safeDisplayMessage({elementId:`${a}-error`,message:m,targetId:a}),o=!0)}return!o}async function handleFormSubmission({evt:e,cID:t,primaryKey:n,clientInfo:r,manageClient:o,manageUser:a,componentId:s}){try{const i=Object.fromEntries(new FormData(e.target)),[m,c]=await Promise.all([validateAllFormFields({userData:i,cID:t,primaryKey:n,manageClient:o,componentId:s}),handleTrimCycleCheck({userData:i,componentId:s})]);if(!m)return top(),safeDisplayMessage({elementId:"form-msg",message:"Please correct all errors before submitting."}),void disableEnableSubmitButton("submit-button");if(!c)return;const{default:l}=await import("./components/addEditFormSubmission.js"),d=await l({evt:e,cID:t,primaryKey:n,manageClient:o}),{status:p,message:u,delete:g}=handleIDBResponse(d);if("success"===p)return top(),safeDisplayMessage({elementId:"form-msg",message:u,isSuccess:!0}),g?void e.target.remove():(checkAppointment({trimDate:"trim-date",trimCycle:"trim-cycle",appBlock:"appointment-block",projAppBlock:"projected-appointment-block",clientInfo:r,manageClient:o,manageUser:a}),void(t||n||e.target.reset()))}catch(e){top();const{AppError:t}=await import("../../../../core/errors/models/AppError.js");t.handleError(e,{errorCode:t.Types.FORM_SUBMISSION_ERROR,userMessage:t.BaseMessages.forms.submissionFailed,displayTarget:"form-msg"})}}async function handleTrimCycleCheck({userData:e,componentId:t}){try{return!trimCycleRange.includes(parseInt(e?.trim_cycle),10)||(top(),safeDisplayMessage({elementId:"trim-cycle-error",message:"Please select a trim cycle",targetId:"trim-cycle"}),addListener({elementOrId:"trim-cycle",eventType:"focus",handler:()=>clearMsg({container:"trim-cycle-error",hide:!0,input:"trim-cycle"}),componentId:t}),disableEnableSubmitButton("submit-button"),!1)}catch(e){const{AppError:t}=await import("../../../../core/errors/models/AppError.js");t.process(e,{errorCode:t.Types.FORM_VALIDATION_ERROR,userMessage:t.BaseMessages.forms.validationFailed,displayTarget:"form-msg"},!0)}}function handleIDBResponse(e){try{if(!e||!e.status)throw new Error("No response data found.");if("success"===e.status&&"delete"===e.type)return{status:"success",message:e.msg,delete:!0};if("success"===e.status)return{status:"success",message:e.msg,delete:!1};throw new Error("Unknown error occurred during form submission.")}catch(e){throw e}}