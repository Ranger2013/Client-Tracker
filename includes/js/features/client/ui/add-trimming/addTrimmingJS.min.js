// @ts-nocheck
import setupClientAnchorListener from"../../../../core/navigation/components/setupClientAnchorListener.js";import checkAppointment from"../../../../core/services/appointment-block/checkAppointment.js";import{disableEnableSubmitButton}from"../../../../core/utils/dom/elements.js";import{addListener}from"../../../../core/utils/dom/listeners.js";import{clearMsg,safeDisplayMessage}from"../../../../core/utils/dom/messages.js";import{ucwords,underscoreToSpaces}from"../../../../core/utils/string/stringUtils.js";import buildListOfHorsesSection from"./components/buildListOfHorsesSection.js";import calculateTotalCost from"./components/calculateTotalCost.js";import{handleShowingAccessoriesSelectBox,handleShowingCostChangeInput,updateCostChangeInput,updateServiceCostSelectedIndex}from"./handlers/costHandlers.js";import handleAddTrimmingFormSubmission from"./handlers/formSubmission.js";const COMPONENT="Add Trimming JS",DEBUG=!1,debugLog=(...e)=>{false};export const prevOptions=new Map;export default async function addTrimming({cID:e,primaryKey:t,mainContainer:r,manageClient:o,manageUser:s,componentId:n}){try{setupClientAnchorListener({manageClient:o,manageUser:s,componentId:n}),debugLog();const a=await o.getClientInfo({primaryKey:t});checkAppointment({trimDate:"next-trim-date",appBlock:"appointment-block",projAppBlock:"projected-appointment-block",clientInfo:a,manageClient:o,manageUser:s});const i={"input:number-horses":async e=>{numberOfHorsesServiced({evt:e,primaryKey:t,manageClient:o,manageUser:s})},"focusin:number-horses":e=>clearMsg({container:`${e.target.id}-error`,hide:!0,input:e.target}),"change:next-trim-date":e=>checkAppointment({trimDate:"next-trim-date",appBlock:"appointment-block",projAppBlock:"projected-appointment-block",clientInfo:a,manageClient:o,manageUser:s}),"change:mileage":async e=>await disableMileageCharges({evt:e}),"submit:trimming-form":s=>{s.preventDefault(),handleAddTrimmingFormSubmission({evt:s,cID:e,primaryKey:t,mainContainer:r,manageClient:o})}},c={"horse-list-":{events:["change"],handler:async(e,r)=>{debugLog(e.target.value),await updateAllHorseListSelectElements(e),await changeServiceCostToMatchHorseService({evt:e,primaryKey:t,manageClient:o}),updateHorseListLabel({evt:e})}},"service-cost-":{events:["change"],handler:async(e,t)=>{debugLog(e.target.value),await handleShowingAccessoriesSelectBox({evt:e,index:t}),await updateCostChangeInput({evt:e,index:t}),calculateTotalCost()}},"checkbox-cost-":{events:["change"],handler:async(e,t)=>{debugLog(e.target.checked),await handleShowingCostChangeInput({evt:e,index:t})}},"cost-change-":{events:["input"],handler:async(e,t)=>{debugLog(e.target.value),await updateServiceCostSelectedIndex({evt:e,index:t}),calculateTotalCost()}},"accessories-":{events:["change"],handler:async(e,t)=>await calculateTotalCost()}};addListener({elementOrId:"card",eventType:["input","change","submit","focusin","click"],handler:e=>{const t=`${e.type}:${e.target.id}`;if(i[t])return debugLog(e.target),void i[t](e);const r=e.target.id;for(const t in c)if(r.startsWith(t)){const o=c[t];if(o.events.includes(e.type)){const t=r.split(/-/g).pop();o.handler(e,t)}return}},componentId:n})}catch(e){debugLog();const{AppError:t}=await import("../../../../core/errors/models/AppError.js");t.handleError(e,{errorCode:t.Types.INITIALIZATION_ERROR,userMessage:t.BaseMessages.system.initialization})}}async function numberOfHorsesServiced({evt:e,primaryKey:t,manageClient:r,manageUser:o}){try{if(debugLog(e.target.value),"0"===e.target.value||""===e.target.value)return safeDisplayMessage({elementId:`${e.target.id}-error`,message:"Please enter the number of horses serviced.",targetId:e.target}),void disableEnableSubmitButton("submit-button");clearMsg({container:`${e.target.id}-error`,hide:!0,input:e.target}),await buildListOfHorsesSection({evt:e,horseListContainer:"number-horse-container",primaryKey:t,manageClient:r,manageUser:o})}catch(e){disableEnableSubmitButton("submit-button");const{AppError:t}=await import("../../../../core/errors/models/AppError.js");t.handleError(e,{errorCode:t.Types.RENDER_ERROR,userMessage:t.BaseMessages.system.render,displayTarget:"number-horses-error"})}}async function disableMileageCharges({evt:e}){try{debugLog(e.target);const t=e.target,r=document.getElementById("mileage-charges");document.getElementById("fuel-cost-display").classList.toggle("w3-hide",t.checked),r.disabled=t.checked,await calculateTotalCost()}catch(e){const{AppError:t}=await import("../../../../core/errors/models/AppError.js");t.handleError(e,{errorCode:t.Types.INITIALIZATION_ERROR,userMessage:"We encountered an error trying to disable mileage charges."})}}async function updateAllHorseListSelectElements(e){try{if(0===prevOptions.size){const e=document.getElementById("trimming-form").querySelectorAll('select[id^="horse-list-"]');for(const t of e){const e=t.options[t.selectedIndex];prevOptions.set(t.id,e)}}debugLog();const t=e.target,r=t.options[t.selectedIndex];let o=document.querySelectorAll('select[id^="horse-list-"]');for(const e of o)if(e.id!==t.id){if(prevOptions.has(t.id)){let r=prevOptions.get(t.id).cloneNode(!0);e.add(r)}for(let t=0;t<e.options.length;t++)if(e.options[t].value===r.value){e.remove(t);break}}prevOptions.set(t.id,r),debugLog()}catch(e){const{AppError:t}=await import("../../../../core/errors/models/AppError.js");t.handleError(e,{errorCode:t.Types.INITIALIZATION_ERROR,userMessage:"We encountered an error trying to update the horse list select elements."})}}async function changeServiceCostToMatchHorseService({evt:e,primaryKey:t,manageClient:r}){try{const o={half_set:"front_",full_set:"full_",trim:"trim"},s=e.target.value.split(":")[0],n=e.target.id.split(/-/g).pop(),a=document.getElementById(`service-cost-${n}`),i=a.options[a.selectedIndex].value,c=(await r.getClientHorses({primaryKey:t})).find((e=>e.hID.toString()===s));if(!c)return;const l=o[c.service_type];if(!i.includes(l)){const e=a.options;let t=!1;for(let r=0;r<e.length;r++)if(e[r].value.includes(l)){a.selectedIndex=r,t=!0;const e=new Event("change",{bubbles:!0,cancelable:!0});Object.defineProperty(e,"target",{value:a}),a.dispatchEvent(e);break}if(!t){a.selectedIndex=0;const e=new Event("change",{bubbles:!0,cancelable:!0});Object.defineProperty(e,"target",{value:a}),a.dispatchEvent(e)}}}catch(e){const{AppError:t}=await import("../../../../core/errors/models/AppError.js");t.handleError(e,{errorCode:t.Types.INITIALIZATION_ERROR,userMessage:"We encountered an error trying to update the service cost to match the horse service."})}}async function updateHorseListLabel({evt:e}){try{const t=e.target.id.split(/-/g).pop(),r=e.target.options[e.target.selectedIndex],o=r.dataset.serviceType,s=r.dataset.trimCycle,n=r.dataset.horseType;document.querySelector(`#horse-trim-cycle-${t}`).innerHTML=`<span class="w3-small">${ucwords(underscoreToSpaces(o))} Cycle: ${s/7} weeks</span>`;document.getElementById(`horse-type-${t}`).innerHTML=""!==n?`Horse Type: ${ucwords(underscoreToSpaces(n))}`:"Horse Type: Unknown"}catch(e){const{AppError:t}=await import("../../../../core/errors/models/AppError.js");t.handleError(e,{errorCode:t.Types.RENDER_ERROR,userMessage:null})}}