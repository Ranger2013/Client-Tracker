// @ts-nocheck
import{buildGenericSelectOptions,disableEnableSubmitButton,getValidElement}from"../../../../../core/utils/dom/elements.js";import{clearMsg}from"../../../../../core/utils/dom/messages.js";import{cleanUserOutput,ucwords,underscoreToSpaces}from"../../../../../core/utils/string/stringUtils.js";import ManageUser from"../../../../user/models/ManageUser.js";import autoFillHorseList from"./autoFillHorseList.js";import calculateTotalCost from"./calculateTotalCost.js";import{updateTrimCost}from"./updateTrimCost.js";import{prevOptions}from"../addTrimmingJS.js";const COMPONENT="BuildListOfHorsesSection",DEBUG=!1,debugLog=(...e)=>{false};export default async function buildListOfHorsesSection({evt:e,horseListContainer:t,primaryKey:o,manageClient:s,manageUser:r}){try{clearMsg({container:"form-msg"});const i=(t=getValidElement(t)).children.length,n=await s.getClientInfo({primaryKey:o}),a=n?.horses||[],l=a.length,c=await r.getFarrierPrices(),{accessories:u,...m}=c,p=getOptionsConfig({clientHorses:a,userFarrierPrices:c});debugLog();const d=await handleShowingNumberOfHorses({evt:e,horseListContainer:t,clientTotalHorses:l,farrierPrices:m,optionsConfig:p,containerChildren:i});d?.forEach((e=>t.appendChild(e)));const f=document.getElementById("number-horses").value;await Promise.all([updateTrimCost({blockElementNode:t,numberHorses:f,userFarrierPrices:m}),calculateTotalCost()]),disableEnableSubmitButton("submit-button")}catch(e){throw e}}function getOptionsConfig({clientHorses:e,userFarrierPrices:t}){const{accessories:o,...s}=t;return{horseListOptionsConfig:{list:e,value:e=>`${e.hID}:${e.horse_name}`,text:e=>e.horse_name},farrierPricesOptionsConfig:{list:Object.entries(s).filter((([e,t])=>""!==t&&"0.00"!==t&&0!==t)).reduce(((e,[t,o])=>{const s=t.includes("trim");return s&&!e.trim?(e.trim=!0,e.list.push({shoe:"trim",price:"xxx"})):s||e.list.push({shoe:t,price:o}),e}),{trim:!1,list:[]}).list,value:e=>`${e.shoe}:${e.price}`,text:e=>ucwords(underscoreToSpaces(e.shoe))},accessoryOptionsConfig:{list:Object.entries(o).filter((([e,t])=>t.length>0)).flatMap((([e,t])=>t.map((t=>({type:e,acc:t.name||e,price:t.cost}))))),value:e=>`${e.type}:${e.acc}:${e.price}`,text:e=>ucwords(e.acc)}}}async function handleShowingNumberOfHorses({evt:e,horseListContainer:t,clientTotalHorses:o,farrierPrices:s,optionsConfig:r,containerChildren:i}){try{let s=parseInt(e.target.value,10);if(prevOptions.clear(),s>=o){s>o&&(s=o,e.target.value=o),t.innerHTML="",debugLog(),debugLog();const i=await autoFillHorseList({totalHorses:o,optionsConfig:r});return i.map((e=>e.querySelector('select[id^="horse-list-"]'))).forEach((e=>{const t=e.options[e.selectedIndex];Array.from(e.options).forEach((o=>{o!==t&&e.removeChild(o)}))})),i}if(s<i){let e=i,o=[];const[r,n]=await Promise.all([import("./removeLastChildAndGetOptions.js"),import("./addOptionToRemainingHorseListSelectElements.js")]),{default:a}=r,{default:l}=n;for(;e>s;){const s=await a(t);s&&o.push(s),e--}o.forEach((e=>l({container:t,optionWithIndex:e})));return t.querySelectorAll('select[id^="horse-list-"]').forEach((e=>{const t=e.options[e.selectedIndex];prevOptions.set(e.id,t)})),[]}debugLog(),t.innerHTML="";const n=await autoFillHorseList({totalHorses:s,optionsConfig:r});return initializeHorseSelections(n),n}catch(e){throw e}}function initializeHorseSelections(e){prevOptions.clear();const t=e.map((e=>{const t=e.querySelector('select[id^="horse-list-"]'),o=t.options[t.selectedIndex];return prevOptions.set(t.id,o),o.value}));e.map((e=>e.querySelector('select[id^="horse-list-"]'))).forEach((e=>{const o=e.options[e.selectedIndex];Array.from(e.options).forEach((s=>{s!==o&&t.includes(s.value)&&e.removeChild(s)}))})),debugLog()}