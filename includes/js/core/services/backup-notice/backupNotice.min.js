// @ts-nocheck
import{addListener}from"../../utils/dom/listeners.js";const TWO_HOURS=72e5,REMINDER_PATTERNS=["add","edit","delete","dateTime","farrierPrices","schedulingOptions","mileageCharges","colorOptions"],BACKUP_NOTICE_ID="backup-notice-component";export default async function setupBackupNotice({errorEleID:e}){try{if(!document.getElementById(e))throw new Error("Backup notice element not found.");await updateBackupNotice(),addListener({elementOrId:`${e}-close`,eventType:"click",handler:closeBackupNotice,componentId:BACKUP_NOTICE_ID})}catch(e){const{errorLogs:t}=await import("../../errors/services/errorLogs.js");await t("backupNotice","Failed to setup backup notice",e),updateNoticeContent(noticeDiv,"Unable to check backup status",!0)}}function updateNoticeContent(e,t,o=!1){const a=e.querySelector("#backup-data-notice-close");e.innerHTML="",a&&e.appendChild(a);const r=document.createElement("span");r.textContent=t,o&&r.classList.add("w3-text-red"),e.insertBefore(r,a),e.classList.remove("w3-hide")}async function updateBackupNotice(){const e=document.getElementById("backup-data-notice");try{const{default:t}=await import("../../database/IndexedDBOperations.js"),o=new t,a=await o.openDBPromise();if(shouldShowReminder(await o.getAllStorePromise(a,o.stores.USERSETTINGS))){const t=filterStores(o.stores,REMINDER_PATTERNS);await checkStoresForData(a,t,o)?updateNoticeContent(e,"You currently have data that needs to be backed up to the server."):hideBackupNotice(e)}}catch(t){const{errorLogs:o}=await import("../../errors/services/errorLogs.js");await o("backupNotice","Failed to check backup status",t),updateNoticeContent(e,"Unable to check for pending backups",!0)}}function clearPreviousMessage(e){e.lastChild&&e.lastChild.nodeType===Node.TEXT_NODE&&e.removeChild(e.lastChild)}function shouldShowReminder(e){if(e&&Object.keys(e).length>0){const t=e[0].reminders.status,o=e[0].reminders.timestamp,a=(new Date).getTime();return("default"===t||"yes"===t)&&(0===o||a-o>=72e5)}return!1}function filterStores(e,t){return Object.keys(e).filter((e=>t.some((t=>e.toLowerCase().includes(t.toLowerCase()))))).reduce(((t,o)=>(t[o]=e[o],t)),{})}async function checkStoresForData(e,t,o){for(let a in t){const r=await o.getAllStorePromise(e,t[a]);if(r&&r.length>0)return!0}return!1}function showBackupNotice(e){const t=document.createTextNode("You currently have data that needs to be backed up to the server.");e.append(t),e.classList.remove("w3-hide")}function hideBackupNotice(e){e.classList.add("w3-hide")}async function closeBackupNotice(){const e=document.getElementById("backup-data-notice");try{const{default:t}=await import("../../database/IndexedDBOperations.js"),{removeListeners:o}=await import("../../utils/dom/listeners.js"),a=new t,r=await a.openDBPromise(),s=await a.getAllStorePromise(r,a.stores.USERSETTINGS);if(!s?.[0])throw new Error("No user settings found");s[0].reminders.timestamp=Date.now(),await a.clearStorePromise(r,a.stores.USERSETTINGS),await a.putStorePromise(r,s[0],a.stores.USERSETTINGS),hideBackupNotice(e),o(BACKUP_NOTICE_ID)}catch(t){await errorLogs("backupNotice","Failed to close backup notice",t),updateNoticeContent(e,"Unable to update notification settings",!0)}}